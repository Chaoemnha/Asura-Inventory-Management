<div class="x_panel">
   <div class="x_title">
      <!-- title row -->
      <div class="row">
         <div class="col-12 col-lg-12 invoice-header">
            <h1 class="row">
               <div class="col-lg-6 text-left col-6">
                  <i class="fa fa-undo"></i> Yêu cầu trả hàng
               </div>
            </h1>
         </div>
         <!-- /.col -->
      </div>
      <div class="clearfix"></div>
   </div>
   <div class="x_content">

      <section class="content invoice" *ngIf="transaction">
         <!-- Original Transaction Information -->
         <div class="row">
            <div class="col-12 table">
               <p class="lead">Thông tin giao dịch gốc</p>
               <table class="table table-striped">
                  <thead>
                     <tr>
                        <th>Transaction ID</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Total Products</th>
                        <th>Total Price</th>
                        <th>Completed At</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr>
                        <td>{{transaction.id}}</td>
                        <td>{{transaction.transactionType}}</td>
                        <td>{{transaction.status}}</td>
                        <td>{{transaction.totalProducts}}</td>
                        <td>{{formatCurrency(transaction.totalPrice)}}</td>
                        <td>{{transaction.updatedAt | date:'short'}}</td>
                     </tr>
                  </tbody>
               </table>
            </div>
            <!-- /.col -->
         </div>
         <!-- /.row -->

         <!-- Product Information -->
         <div class="row invoice-info">
            <div class="col-sm-6 invoice-col">
               <p class="lead">Thông tin sản phẩm</p>
               <b>Tên:</b> {{transaction.product.name}}
               <br>
               <b>SKU:</b> {{transaction.product.sku}}
               <br>
               <b>Giá mỗi sản phẩm:</b> {{formatCurrency(transaction.totalPrice/maxReturnQuantity)}}
               <br>
               <b>Mô tả:</b> {{transaction.product.description}}
               <div *ngIf="transaction.product.imageUrl" class="mt-3">
                  <img [src]='transaction.product.imageUrl' [alt]="transaction.product.name" class="product-image"
                       style="width: 8rem; height: 8rem; object-fit: cover;" />
               </div>
            </div>
            <!-- /.col -->
            <div class="col-sm-6 invoice-col">
               <p class="lead">Thông tin trả hàng</p>
               <div class="form-group">
                  <label for="returnQuantity"><strong>Số lượng trả:</strong></label>
                  <input 
                     type="number" 
                     id="returnQuantity"
                     class="form-control"
                     [(ngModel)]="returnQuantity"
                     [min]="1"
                     [max]="maxReturnQuantity"
                     placeholder="Nhập số lượng muốn trả">
                  <small class="form-text text-muted">
                     Số lượng tối đa có thể trả: {{maxReturnQuantity}}
                  </small>
               </div>
               
               <div class="return-summary mt-3">
                  <p><strong>Số tiền trả lại:</strong> {{formatCurrency(getReturnAmount())}}</p>
               </div>
            </div>
            <!-- /.col -->
         </div>
         <!-- /.row -->

         <hr>

         <!-- Return Reason Form -->
         <div class="row">
            <div class="col-12">
               <p class="lead">Lý do trả hàng</p>
               <div class="form-group">
                  <label for="returnReason"><strong>Vui lòng nhập lý do chi tiết:</strong></label>
                  <textarea 
                     id="returnReason"
                     class="form-control"
                     [(ngModel)]="returnReason"
                     rows="5"
                     placeholder="Nhập lý do trả hàng (bắt buộc)"
                     maxlength="1000">
                  </textarea>
                  <small class="form-text text-muted">
                     {{returnReason.length}}/1000 ký tự
                  </small>
               </div>
            </div>
         </div>

         <hr>

         <!-- /.row -->

         <!-- Action Buttons -->
         <div class="row no-print mt-4">
            <div class="col-12">
               <div class="text-center">
                  <button 
                     class="btn btn-danger btn-lg mr-3" 
                     (click)="cancelReturn()"
                     [disabled]="isLoading">
                     <i class="fa fa-times"></i> Hủy
                  </button>
                  
                  <button 
                     class="btn btn-success btn-lg"
                     (click)="handleReturnSubmit()"
                     [disabled]="!canReturn() || !returnReason.trim() || returnQuantity <= 0 || isLoading">
                     <i class="fa fa-check" *ngIf="!isLoading"></i>
                     <i class="fa fa-spinner fa-spin" *ngIf="isLoading"></i>
                     {{isLoading ? 'Đang xử lý...' : 'Gửi yêu cầu trả hàng'}}
                  </button>
               </div>
            </div>
         </div>

      </section>

      <!-- Loading state -->
      <div *ngIf="!transaction" class="text-center">
         <i class="fa fa-spinner fa-spin fa-3x"></i>
         <p class="mt-3">Đang tải thông tin giao dịch...</p>
      </div>

      <!-- Error state -->
      <div *ngIf="transaction && !canReturn()" class="alert alert-danger">
         <h4><i class="fa fa-exclamation-triangle"></i> Không thể xử lý trả hàng</h4>
         <p>Giao dịch này không thể trả hàng. Lý do có thể:</p>
         <ul>
            <li>Bạn không phải người mua</li>
            <li>Giao dịch chưa hoàn thành</li>
            <li>Đây không phải giao dịch bán hàng</li>
            <li>Đã hết thời gian trả hàng</li>
         </ul>
         <button class="btn btn-primary" (click)="cancelReturn()">
            <i class="fa fa-arrow-left"></i> Quay lại
         </button>
      </div>

   </div>
</div>