<div class="x_panel">
   <div class="x_title">
         <!-- title row -->
         <div class="row">
            <div class="col-12 col-lg-12 invoice-header">
               <h1 class="row">
                  <div class="col-lg-6 text-left col-6">
                     <i class="fa fa-exchange"></i> Giao dịch.{{transaction?.id||''}}
                  </div>
               </h1>
            </div>
            <!-- /.col -->
         </div>
      <div class="clearfix"></div>
   </div>
   <div class="x_content">

      <section class="content invoice">
         <!-- Table row -->
         <div class="row">
            <div class="col-12 table">
               <p class="lead">Thông tin giao dịch</p>
               <table class="table table-striped">
                  <thead>
                     <tr>
                        <th>Loại</th>
                        <th>Trạng thái</th>
                        <th>Tổng số SP</th>
                        <th>Mô tả</th>
                        <th>Tổng tiền</th>
                        <th *ngIf="transaction?.updatedAt==null">Ngày tạo</th>
                        <th *ngIf="transaction?.updatedAt!=null">Ngày cập nhật</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr>
                        <td>{{transaction.transactionType}}</td>
                        <td>{{transaction.status}}</td>
                        <td>{{transaction.totalProducts}}</td>
                        <td>{{transaction.description}}</td>
                        <td>{{transaction.totalPrice | currency}}</td>
                        <td *ngIf="!transaction?.updatedAt">{{transaction?.createdAt | date:'shortDate'}}</td>
                        <td *ngIf="transaction?.updatedAt">{{transaction?.updatedAt | date:'shortDate'}}</td>
                     </tr>
                  </tbody>
               </table>
            </div>
            <!-- /.col -->
         </div>
         <!-- /.row -->
         <!-- info row -->
         <div class="row invoice-info">
            <div class="col-sm-4 invoice-col">
               <p class="lead">Thông tin sản phẩm</p>
               <b>Tên:</b> {{transaction.product.name}}
               <br>
               <b>SKU:</b> {{transaction.product.sku}}
               <br>
               <b>Giá:</b> {{transaction.product.price | currency}}
               <br>
               <b>Tồn kho:</b> {{transaction.product.stockQuantity}}
               <br>
               <b>Mô tả:</b> {{transaction.product.description}}
               <div *ngIf="transaction.product.imageUrl">
                  <img [src]='transaction.product.imageUrl' [alt]="transaction.product.name" class="product-image"
                style="width: 5rem; height: 5rem; object-fit: cover;" />
               </div>
            </div>
            <!-- /.col -->
            <div class="col-sm-4 invoice-col">
               <p class="lead" *ngIf="transaction.transactionType=='PURCHASE'||transaction.transactionType=='RETURN_TO_SUPPLIER'">Nhà cung cấp</p>
               <p class="lead" *ngIf="transaction.transactionType=='SALE'">Kho hàng</p>
               <address>
                  <strong>Tên: {{transaction.supplier.name}}</strong><br>
                  <b>Địa chỉ:</b> {{transaction.supplier.address}}<br>
                  <b>SĐT:</b> {{transaction.supplier.phone}}<br>
                  <b>Email:</b> {{transaction.supplier.email}}<br>
                  <b *ngIf="transaction.transactionType=='PURCHASE'||transaction.transactionType=='RETURN_TO_SUPPLIER'||transaction.transactionType=='SALE'">Nhân viên: </b>
                  <span *ngIf="transaction.transactionType=='PURCHASE'||transaction.transactionType=='RETURN_TO_SUPPLIER'||transaction.transactionType=='SALE'">
                    <a *ngIf="isStaffUser(transaction.sender)&&isAdmin" 
                       href="javascript:void(0)" 
                       (click)="navigateToStaffProfile(transaction.sender.id)"
                       class="staff-link">
                      <b>{{ transaction.sender.name }}</b>
                    </a>
                    <span *ngIf="isStaffUser(transaction.sender)&&!isAdmin" >
                      <b>{{ transaction.sender.name }}</b>
                  </span>
                    <span *ngIf="!isStaffUser(transaction.sender)">
                      <b>{{ transaction.sender?.name || '' }}</b>
                    </span>
                    <br>
                  </span>
               </address>
            </div>
            <!-- /.col -->
            <div class="col-sm-4 invoice-col">
              <p class="lead">Người dùng</p>
               <address>
                  <strong>Tên: 
                    <a *ngIf="isStaffUser(transaction.user)" 
                       href="javascript:void(0)" 
                       (click)="navigateToStaffProfile(transaction.user.id)"
                       class="staff-link">
                      {{ transaction.user.name }}
                    </a>
                    <span *ngIf="!isStaffUser(transaction.user)">
                      {{ transaction.user.name }}
                    </span>
                  </strong><br>
                  <b *ngIf="transaction.transactionType=='RETURN_TO_SUPPLIER'||transaction.transactionType=='PURCHASE'">Địa chỉ kho:</b> <span *ngIf="transaction.transactionType=='RETURN_TO_SUPPLIER'||transaction.transactionType=='PURCHASE'">{{transaction.user.supplier.address}}<br></span>
                  <b *ngIf="transaction.transactionType=='SALE'">Địa chỉ:</b> <span *ngIf="transaction.transactionType=='SALE'">{{transaction.user.address}}<br></span>
                  <b>SĐT:</b> {{transaction.user.phoneNumber}}<br>
                  <b>Email:</b> {{transaction.user.email}}
               </address>
            </div>
            <!-- /.col -->
         </div>
         <!-- /.row -->

         <hr>
         <!-- /.row -->

         <!-- this row will not appear when printing -->
         <div class="row no-print">
            <div class="col-12">
               <span class="lead"><b>Trạng thái: </b></span>
               <span class="badge" [class.badge-success]="transaction.status === 'COMPLETED'"
                [class.badge-warning]="transaction.status === 'PENDING'"
                [class.badge-info]="transaction.status === 'ADMIN_DECIDING'"
                [class.badge-primary]="transaction.status === 'SENDER_DECIDING'"
                [class.badge-dark]="transaction.status === 'SENDER_DECLINED'"
                [class.badge-secondary]="transaction.status === 'CANCELED'">
                {{ transaction.status }}
              </span>
               <button class="btn btn-success pull-right mr-2" *ngIf="canScanQR"
                  (click)="confirmArrival()"><i class="fa fa-qrcode"></i> Xác nhận QR
               </button>
               <button class="btn btn-success pull-right mr-2" *ngIf="(status=='ADMIN_DECIDING'||status=='SENDER_DECLINED')&&(type=='RETURN_TO_SUPPLIER')&&isAdmin"
                  (click)="confirmReturn()"><i class="fa fa-thumbs-o-up"></i> Duyệt trả
               </button>
               <button class="btn btn-danger pull-right mr-2" *ngIf="(status=='ADMIN_DECIDING'||status=='SENDER_DECLINED')&&(type=='RETURN_TO_SUPPLIER')&&isAdmin"
                  (click)="rejectReturn()"><i class="fa fa-thumbs-o-down"></i> Từ chối trả
               </button>
               <button class="btn btn-success pull-right mr-2" *ngIf="status=='ADMIN_DECIDING'&&(type=='PURCHASE'||type=='SALE')&&isAdmin"
                  (click)="confirmTransaction()"><i class="fa fa-thumbs-o-up"></i> Duyệt giao dịch
               </button>
               <button class="btn btn-danger pull-right mr-2" *ngIf="status=='ADMIN_DECIDING'&&(type=='PURCHASE'||type=='SALE')&&isAdmin"
                  (click)="rejectTransaction()"><i class="fa fa-thumbs-o-down"></i> Từ chối giao dịch
               </button>
               <button class="btn btn-success pull-right mr-2" *ngIf="status=='SENDER_DECIDING'&&(type=='PURCHASE'||type=='SALE')&&transaction.supplier.id==user.supplier.id"
                  (click)="confirmSender()"><i class="fa fa-thumbs-o-up"></i> Xác nhận gửi
               </button>
               <!-- Sender actions for RETURN transactions -->
               <button class="btn btn-success pull-right mr-2" *ngIf="status=='SENDER_DECIDING'&&type=='RETURN_TO_SUPPLIER'&&transaction.sender.id==user.id"
                  (click)="senderAgree()"><i class="fa fa-check"></i> Đồng ý gửi
               </button>
               <button class="btn btn-warning pull-right mr-2" *ngIf="status=='SENDER_DECIDING'&&type=='RETURN_TO_SUPPLIER'&&transaction.sender.id==user.id"
                  (click)="senderDecline()"><i class="fa fa-times"></i> Từ chối gửi
               </button>
               <button class="btn btn-danger pull-right mr-2" (click)="navigateToReturnPage()" *ngIf="canReturn">Yêu cầu trả hàng</button>
               <button class="btn btn-primary pull-right mr-2" style="margin-right: 5px;" *ngIf="canGenQR"
                       (click)="generatePDF()"><i class="fa fa-download"></i>
                  Tải hóa đơn PDF
               </button>
            </div>
         </div>
      </section>
   </div>
</div>

<!-- QR Scanner Modal -->
<app-qr-scanner 
  *ngIf="showQrScanner"
  [expectedTransactionId]="transaction?.id?.toString() || ''"
  (closeScanner)="onCloseQrScanner()">
</app-qr-scanner>