<div class="x_panel">
  <div class="purchase-form-page">
    <h1>{{ isCustomer ? 'Mua sản phẩm' : 'Bán sản phẩm' }}</h1>

    <!-- PRODUCT PURCHASE? INVENTORY RECEIVING PAGE -->
    <form (ngSubmit)="handleSubmit()">

      <div class="form-group">
        <div class="row">
          <label class="control-label col-md-3 col-sm-3 col-12">Chọn sản phẩm<span class="required">*</span></label>
          <div class="col-md-6 col-sm-6 col-12">
            <select name="productId" class="form-control" [(ngModel)]="productId" (change)="onProductChange()" id="">
              <option value="">Chọn một sản phẩm</option>
              <option *ngFor="let product of products" [value]="product.id">
                {{ product.name }}
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- Product Information Display -->
      <div class="form-group" *ngIf="selectedProduct">
        <div class="row">
          <label class="control-label col-md-3 col-sm-3 col-12">Thông tin sản phẩm</label>
          <div class="col-md-6 col-sm-6 col-12">
            <div class="alert alert-info">
              <p><strong>Tên:</strong> {{ selectedProduct.name }}</p>
              <p><strong>Mã SKU:</strong> {{ selectedProduct.sku }}</p>
              <p><strong>Đơn giá:</strong> {{ unitPrice | number:'1.0-0' }}₫</p>
              <p><strong>Tồn kho:</strong> {{ selectedProduct.stockQuantity }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- User Selection for ADMIN/STOCKSTAFF -->
      <div class="form-group" *ngIf="isAdminOrStaff">
        <div class="row">
          <label class="control-label col-md-3 col-sm-3 col-12">Chọn khách hàng<span class="required">*</span></label>
          <div class="col-md-6 col-sm-6 col-12">
            <select name="userId" class="form-control" [(ngModel)]="userId" id="">
              <option value="">Chọn một khách hàng</option>
              <option *ngFor="let user of users" [value]="user.id">
                {{ user.name }}
              </option>
            </select>
          </div>
        </div>
      </div>


      <div class="form-group">
        <div class="row">
          <label class="control-label col-md-3 col-sm-3 col-12">Mô tả</label>
          <div class="col-md-6 col-sm-6 col-12">
            <textarea [(ngModel)]="description" name="description" class="form-control" rows="3" placeholder="Description..."></textarea>
          </div>
        </div>
      </div>


      <div class="form-group">
        <div class="row">
          <label class="control-label col-md-3 col-sm-3 col-12">Số lượng<span class="required">*</span>
          </label>
          <div class="col-md-6 col-sm-6 col-12">
            <input type="number" [(ngModel)]="quantity" name="quantity" class="form-control col-md-7 col-12" 
                   (input)="onQuantityChange()" min="1" [max]="selectedProduct?.stockQuantity || 9999">
          </div>
        </div>
      </div>

      <!-- Total Price Display -->
      <div class="form-group" *ngIf="selectedProduct && quantity">
        <div class="row">
          <label class="control-label col-md-3 col-sm-3 col-12">Tổng tiền</label>
          <div class="col-md-6 col-sm-6 col-12">
            <div class="alert alert-success">
              <h4><strong>{{ totalPrice | number:'1.0-0' }}₫</strong></h4>
              <p><small>{{ quantity }} × {{ unitPrice | number:'1.0-0' }}₫</small></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Only Fields -->
      <div *ngIf="isAdmin()">
        <div class="form-group">
          <div class="row">
            <label class="control-label col-md-3 col-sm-3 col-12">Ngày tạo</label>
            <div class="col-md-6 col-sm-6 col-12">
              <input type="datetime-local" [(ngModel)]="createdAt" name="createdAt" class="form-control">
              <small class="form-text text-muted">Để trống sẽ sử dụng thời gian hiện tại</small>
            </div>
          </div>
        </div>

        <div class="form-group">
          <div class="row">
            <label class="control-label col-md-3 col-sm-3 col-12">Trạng thái</label>
            <div class="col-md-6 col-sm-6 col-12">
              <select name="status" class="form-control" [(ngModel)]="status">
                <option value="">Mặc định</option>
                <option value="PENDING">PENDING</option>
                <option value="COMPLETED">COMPLETED</option>
                <option value="CANCELED">CANCELED</option>
                <option value="SENDER_DECIDING">SENDER_DECIDING</option>
                <option value="ADMIN_DECIDING">ADMIN_DECIDING</option>
                <option value="SENDER_DECLINED">SENDER_DECLINED</option>
              </select>
              <small class="form-text text-muted">Để trống sẽ sử dụng trạng thái mặc định</small>
            </div>
          </div>
        </div>
      </div>
      

      <button type="submit" class="btn btn-primary mr-1">{{isCustomer?'Mua':'Xuất'}}</button>
      <button class="btn btn-primary" type="reset">Đặt lại</button>
    </form>
  </div>
</div>